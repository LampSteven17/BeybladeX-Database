---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Meta Dashboard">
  <div class="max-w-9xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

    {/* ============================================
        META CHAMPION SPOTLIGHT (Full-width Hero)
        ============================================ */}
    <section class="mb-6">
      <div id="meta-spotlight" class="w-full">
        <!-- Loading State -->
        <div id="spotlight-loading" class="champion-spotlight p-8 min-h-[280px] flex items-center justify-center w-full">
          <div class="flex items-center gap-3">
            <div class="w-6 h-6 border-2 border-terminal-border border-t-gold rounded-full animate-spin"></div>
            <span class="text-fg-muted font-mono text-sm">LOADING META DATA...</span>
          </div>
        </div>
      </div>
    </section>

    {/* ============================================
        META EVOLUTION - Historical Timeline
        ============================================ */}
    <section class="mb-6">
      <div class="terminal-panel">
        <div class="terminal-panel-header">
          <span class="flex items-center gap-2">
            <svg class="w-4 h-4 text-tier-ss" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Meta Evolution
          </span>
          <span class="text-fg-muted text-[10px]">How the meta changed over time</span>
        </div>
        <div class="terminal-panel-body">
          {/* Era Timeline Visualization */}
          <div id="meta-evolution-loading" class="flex items-center justify-center py-8">
            <div class="flex items-center gap-3">
              <div class="w-5 h-5 border-2 border-terminal-border border-t-tier-ss rounded-full animate-spin"></div>
              <span class="text-fg-muted font-mono text-sm">Loading meta history...</span>
            </div>
          </div>
          
          <div id="meta-evolution-content" class="hidden">
            {/* Visual Timeline */}
            <div id="meta-timeline" class="mb-6">
              <div class="relative">
                {/* Timeline bar */}
                <div class="h-2 bg-surface rounded-full mb-4 overflow-hidden flex">
                  <div id="era-bar-0" class="h-full bg-series-bx/60" style="width: 25%"></div>
                  <div id="era-bar-1" class="h-full bg-series-ux/60" style="width: 25%"></div>
                  <div id="era-bar-2" class="h-full bg-series-cx/60" style="width: 25%"></div>
                  <div id="era-bar-3" class="h-full bg-tier-ss/60" style="width: 25%"></div>
                </div>
                
                {/* Era cards */}
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3" id="era-cards">
                  {/* Populated by JS */}
                </div>
              </div>
            </div>
            
            {/* Blade Journey Visualization */}
            <div class="border-t border-stroke pt-4">
              <div class="flex items-center justify-between mb-3">
                <span class="text-xs font-mono text-fg-muted uppercase tracking-widest">Top Blade Rankings Over Time</span>
              </div>
              <div id="blade-journey-chart" class="h-40 relative">
                {/* SVG journey lines rendered by JS */}
              </div>
              <div id="blade-journey-legend" class="flex flex-wrap gap-3 mt-2 text-xs">
                {/* Legend populated by JS */}
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    {/* ============================================
        MARKET OVERVIEW + MOVERS ROW
        ============================================ */}
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      {/* Database Statistics (Dense stat widgets) */}
      <div class="terminal-panel">
        <div class="terminal-panel-header">
          <span class="flex items-center gap-2">
            <span class="status-dot status-dot-live"></span>
            Database Statistics
          </span>
          <span class="text-fg-muted text-[10px]">All Time</span>
        </div>
        <div class="terminal-panel-body">
          <div class="grid grid-cols-4 gap-3">
            <div class="stat-widget">
              <div class="stat-widget-label">Tournaments</div>
              <div id="stat-tournaments" class="stat-widget-value text-accent">--</div>
            </div>
            <div class="stat-widget">
              <div class="stat-widget-label">Players</div>
              <div id="stat-players" class="stat-widget-value text-series-ux">--</div>
            </div>
            <div class="stat-widget">
              <div class="stat-widget-label">Blades</div>
              <div id="stat-blades" class="stat-widget-value text-series-bx">--</div>
            </div>
            <div class="stat-widget">
              <div class="stat-widget-label">Combos</div>
              <div id="stat-combos" class="stat-widget-value text-series-cx">--</div>
            </div>
          </div>
        </div>
      </div>

      {/* 30-Day Trends Panel (Risers | Fallers) */}
      <div class="terminal-panel">
        <div class="terminal-panel-header">
          <span>30-Day Trends</span>
          <span class="text-fg-muted text-[10px]">vs Previous 30d</span>
        </div>
        <div class="terminal-panel-body">
          <div class="grid grid-cols-2 gap-4">
            {/* Risers */}
            <div>
              <div class="text-[10px] font-mono uppercase tracking-widest text-positive mb-2 flex items-center gap-1">
                <span class="delta-up"></span> Risers
              </div>
              <div id="movers-risers" class="space-y-1">
                <div class="data-row skeleton h-6"></div>
                <div class="data-row skeleton h-6"></div>
                <div class="data-row skeleton h-6"></div>
              </div>
            </div>
            {/* Fallers */}
            <div>
              <div class="text-[10px] font-mono uppercase tracking-widest text-negative mb-2 flex items-center gap-1">
                <span class="delta-down"></span> Fallers
              </div>
              <div id="movers-fallers" class="space-y-1">
                <div class="data-row skeleton h-6"></div>
                <div class="data-row skeleton h-6"></div>
                <div class="data-row skeleton h-6"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    {/* ============================================
        TOP PERFORMERS (Blades + Combos)
        ============================================ */}
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      {/* Top Blades */}
      <div class="terminal-panel">
        <div class="terminal-panel-header">
          <span class="flex items-center gap-2">
            <span class="text-accent">#</span> Top Blades
          </span>
          <a href="/blades" class="text-accent hover:text-fg text-[10px] uppercase tracking-wider transition-colors">
            View All
          </a>
        </div>
        <div id="top-blades" class="terminal-panel-body p-0">
          {[1, 2, 3, 4, 5, 6, 7, 8].map(() => (
            <div class="data-row skeleton h-8"></div>
          ))}
        </div>
      </div>

      {/* Top Combos */}
      <div class="terminal-panel">
        <div class="terminal-panel-header">
          <span class="flex items-center gap-2">
            <span class="text-series-ux">#</span> Top Combos
          </span>
          <a href="/combos" class="text-series-ux hover:text-fg text-[10px] uppercase tracking-wider transition-colors">
            View All
          </a>
        </div>
        <div id="top-combos" class="terminal-panel-body p-0">
          {[1, 2, 3, 4, 5, 6, 7, 8].map(() => (
            <div class="data-row skeleton h-8"></div>
          ))}
        </div>
      </div>
    </section>

    {/* ============================================
        PARTS ANALYSIS (Ratchets + Bits)
        ============================================ */}
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      {/* Top Ratchets */}
      <div class="terminal-panel">
        <div class="terminal-panel-header">
          <span class="flex items-center gap-2">
            <span class="text-series-ux">#</span> Ratchets
          </span>
          <a href="/ratchets" class="text-series-ux hover:text-fg text-[10px] uppercase tracking-wider transition-colors">
            View All
          </a>
        </div>
        <div id="ratchet-bars" class="terminal-panel-body space-y-2">
          {[1, 2, 3, 4, 5].map(() => (
            <div class="skeleton h-6 rounded"></div>
          ))}
        </div>
      </div>

      {/* Top Bits */}
      <div class="terminal-panel">
        <div class="terminal-panel-header">
          <span class="flex items-center gap-2">
            <span class="text-series-bx">#</span> Bits
          </span>
          <a href="/bits" class="text-series-bx hover:text-fg text-[10px] uppercase tracking-wider transition-colors">
            View All
          </a>
        </div>
        <div id="bit-bars" class="terminal-panel-body space-y-2">
          {[1, 2, 3, 4, 5].map(() => (
            <div class="skeleton h-6 rounded"></div>
          ))}
        </div>
      </div>
    </section>

    {/* ============================================
        META LANDSCAPE (Full-width Chart)
        ============================================ */}
    <section class="mb-6">
      <div class="terminal-panel">
        <div class="terminal-panel-header">
          <span class="flex items-center gap-2">
            <span class="text-accent">#</span> Meta Landscape
          </span>
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-3 text-[10px]">
              <div class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-series-bx"></span>
                <span class="text-fg-muted">BX</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-series-ux"></span>
                <span class="text-fg-muted">UX</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-series-cx"></span>
                <span class="text-fg-muted">CX</span>
              </div>
            </div>
            <span class="text-fg-disabled text-[10px]">Uses vs Win% (bubble = score)</span>
          </div>
        </div>
        <div class="terminal-panel-body">
          <div class="relative h-64 md:h-80">
            <canvas id="meta-landscape-chart"></canvas>
          </div>
        </div>
      </div>
    </section>

    {/* ============================================
        SERIES BREAKDOWN (BX / UX / CX)
        ============================================ */}
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      {/* BX Series */}
      <div class="terminal-panel border-series-bx/30">
        <div class="terminal-panel-header bg-series-bx/10">
          <span class="flex items-center gap-2">
            <span class="badge-bx text-[10px] px-1.5 py-0.5">BX</span>
            Basic Series
          </span>
        </div>
        <div id="series-bx" class="terminal-panel-body p-0">
          {[1, 2, 3, 4, 5].map(() => (
            <div class="data-row skeleton h-6"></div>
          ))}
        </div>
      </div>

      {/* UX Series */}
      <div class="terminal-panel border-series-ux/30">
        <div class="terminal-panel-header bg-series-ux/10">
          <span class="flex items-center gap-2">
            <span class="badge-ux text-[10px] px-1.5 py-0.5">UX</span>
            Unique Series
          </span>
        </div>
        <div id="series-ux" class="terminal-panel-body p-0">
          {[1, 2, 3, 4, 5].map(() => (
            <div class="data-row skeleton h-6"></div>
          ))}
        </div>
      </div>

      {/* CX Series */}
      <div class="terminal-panel border-series-cx/30">
        <div class="terminal-panel-header bg-series-cx/10">
          <span class="flex items-center gap-2">
            <span class="badge-cx text-[10px] px-1.5 py-0.5">CX</span>
            Custom Line
          </span>
        </div>
        <div id="series-cx" class="terminal-panel-body p-0">
          {[1, 2, 3, 4, 5].map(() => (
            <div class="data-row skeleton h-6"></div>
          ))}
        </div>
      </div>
    </section>

  </div>
</Layout>

<script>
  import { initDB, getDatabaseSummary, getRankedBlades, getRankedCombos, getRankedRatchets, getRankedBits, getMetaSpotlight, getTopBladesBySeries, getBladesSparklineData, getCombosSparklineData, getMetaEvolution, BLADE_SERIES, type Region, type BladeStats, type ComboStats, type MetaEvolutionData } from '../lib/db';
  import { staggerFadeIn, animateNumber } from '../lib/animations';
  import { generateTrendSparkline } from '../lib/sparkline';
  import { Chart, BubbleController, LinearScale, PointElement, Tooltip, Legend } from 'chart.js';

  Chart.register(BubbleController, LinearScale, PointElement, Tooltip, Legend);

  let metaLandscapeChart: Chart | null = null;

  function getSelectedRegion(): Region {
    if (typeof localStorage !== 'undefined') {
      return (localStorage.getItem('beyblade-region') as Region) || 'ALL';
    }
    return 'ALL';
  }

  async function loadDashboard() {
    try {
      await initDB();
      const region = getSelectedRegion();

      // Load all data in parallel
      const [summary, blades, combos, ratchets, bits, spotlight, seriesBlades, allBlades] = await Promise.all([
        getDatabaseSummary(region),
        getRankedBlades(8, 3, region),
        getRankedCombos(8, 2, region),
        getRankedRatchets(5, 3, region),
        getRankedBits(5, 3, region),
        getMetaSpotlight(region),
        getTopBladesBySeries(5, 2, region),
        getRankedBlades(50, 2, region),
      ]);

      // Fetch real sparkline data for top blades and combos
      const [bladeSparklines, comboSparklines] = await Promise.all([
        getBladesSparklineData(blades.map((b: BladeStats) => b.blade), 7, region),
        getCombosSparklineData(combos.map((c: ComboStats) => ({ blade: c.blade, ratchet: c.ratchet, bit: c.bit })), 7, region),
      ]);

      // Render champion spotlight
      renderChampionSpotlight(spotlight);

      // Render movers
      renderMovers(spotlight);

      // Update stats
      const tournamentsEl = document.getElementById('stat-tournaments');
      const playersEl = document.getElementById('stat-players');
      const bladesEl = document.getElementById('stat-blades');
      const combosEl = document.getElementById('stat-combos');

      if (tournamentsEl) animateNumber(tournamentsEl, summary.tournaments);
      if (playersEl) animateNumber(playersEl, summary.unique_players);
      if (bladesEl) animateNumber(bladesEl, summary.unique_blades);
      if (combosEl) animateNumber(combosEl, combos.length > 0 ? summary.unique_blades * 2 : 0);

      // Render top blades with real sparklines
      renderTopBlades(blades, bladeSparklines);

      // Render top combos with real sparklines
      renderTopCombos(combos, comboSparklines);

      // Render part bars
      renderPartBars(ratchets, bits);

      // Render series rankings
      renderSeriesBlades('series-bx', seriesBlades.BX, 'series-bx');
      renderSeriesBlades('series-ux', seriesBlades.UX, 'series-ux');
      renderSeriesBlades('series-cx', seriesBlades.CX, 'series-cx');

      // Render meta landscape
      renderMetaLandscape(allBlades);

      // Load and render meta evolution (async, non-blocking)
      loadMetaEvolution(region);

    } catch (error) {
      console.error('Failed to load dashboard:', error);
      document.querySelectorAll('.skeleton').forEach(el => {
        el.classList.remove('skeleton');
        el.innerHTML = '<div class="text-center text-negative py-2 text-xs">Error</div>';
      });
    }
  }

  function renderChampionSpotlight(spotlight: { champion: any; risers: any[]; fallers: any[]; lastTournamentDate: string | null; isStale: boolean; dataSource: 'recent' | 'extended' }) {
    const container = document.getElementById('meta-spotlight');
    if (!container) return;

    if (!spotlight.champion) {
      container.innerHTML = `
        <div class="terminal-panel p-6 text-center">
          <div class="text-fg-muted font-mono">No tournament data available</div>
        </div>
      `;
      return;
    }

    const { champion, isStale } = spotlight;
    const metaShare = ((champion.uses / 100) * champion.winRate).toFixed(1);

    container.innerHTML = `
      <div class="champion-spotlight w-full">
        <div class="relative p-6 md:p-8 min-h-[240px]">
          <!-- Status Badge -->
          <div class="absolute top-4 right-4 flex items-center gap-2">
            <span class="status-dot ${isStale ? 'status-dot-stale' : 'status-dot-live'}"></span>
            <span class="text-[10px] font-mono uppercase tracking-widest ${isStale ? 'text-series-cx' : 'text-positive'}">
              ${isStale ? 'HISTORICAL' : 'LIVE'}
            </span>
          </div>

          <!-- Champion Label -->
          <div class="text-[10px] font-mono uppercase tracking-widest text-gold mb-2">
            Meta Champion <span class="text-fg-muted">(Last 30 Days)</span>
          </div>

          <!-- Champion Name (Hero Element) -->
          <h1 class="champion-name text-fg mb-4">
            ${champion.blade} ${champion.ratchet} ${champion.bit}
          </h1>

          <!-- Stats Grid -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
            <div class="text-center">
              <div class="text-3xl md:text-4xl font-mono font-bold text-gold tabular-nums">${champion.score.toFixed(1)}</div>
              <div class="text-[10px] font-mono uppercase tracking-widest text-fg-muted mt-1">Score</div>
            </div>
            <div class="text-center">
              <div class="text-3xl md:text-4xl font-mono font-bold text-positive tabular-nums">${champion.winRate}%</div>
              <div class="text-[10px] font-mono uppercase tracking-widest text-fg-muted mt-1">1st Rate</div>
            </div>
            <div class="text-center">
              <div class="text-3xl md:text-4xl font-mono font-bold text-series-ux tabular-nums">${champion.uses}</div>
              <div class="text-[10px] font-mono uppercase tracking-widest text-fg-muted mt-1">Uses</div>
            </div>
            <div class="text-center">
              <div class="text-3xl md:text-4xl font-mono font-bold text-accent tabular-nums">${metaShare}%</div>
              <div class="text-[10px] font-mono uppercase tracking-widest text-fg-muted mt-1">Meta Share</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderMovers(spotlight: { risers: any[]; fallers: any[] }) {
    const risersContainer = document.getElementById('movers-risers');
    const fallersContainer = document.getElementById('movers-fallers');

    if (risersContainer) {
      if (spotlight.risers.length === 0) {
        risersContainer.innerHTML = '<div class="text-fg-muted text-xs py-2">No risers</div>';
      } else {
        risersContainer.innerHTML = spotlight.risers.slice(0, 3).map(r => `
          <div class="data-row">
            <span class="data-row-name text-xs">${r.blade} ${r.ratchet} ${r.bit}</span>
            <span class="delta-up text-xs">+${r.change}</span>
          </div>
        `).join('');
      }
    }

    if (fallersContainer) {
      if (spotlight.fallers.length === 0) {
        fallersContainer.innerHTML = '<div class="text-fg-muted text-xs py-2">No fallers</div>';
      } else {
        fallersContainer.innerHTML = spotlight.fallers.slice(0, 3).map(f => `
          <div class="data-row">
            <span class="data-row-name text-xs">${f.blade} ${f.ratchet} ${f.bit}</span>
            <span class="delta-down text-xs">${f.change}</span>
          </div>
        `).join('');
      }
    }
  }

  function renderTopBlades(blades: any[], sparklineData: Record<string, number[]>) {
    const container = document.getElementById('top-blades');
    if (!container) return;

    container.innerHTML = blades.map((b, i) => {
      const winRate = b.uses > 0 ? ((b.first / b.uses) * 100).toFixed(0) : '0';
      // Use real historical sparkline data
      const data = sparklineData[b.blade] || [0, 0, 0, 0, 0, 0, 0];
      const sparkline = generateTrendSparkline(data, { width: 50, height: 16 });

      return `
        <div class="data-row py-2 px-3 ${i === 0 ? 'bg-gold/5 border-l-2 border-gold' : ''}">
          <span class="data-row-rank ${i === 0 ? 'text-gold' : ''}">${i + 1}</span>
          <span class="data-row-name ${i === 0 ? 'text-gold font-bold' : ''}">${b.blade}</span>
          <span class="sparkline ml-2">${sparkline}</span>
          <span class="data-row-secondary">${b.uses}</span>
          <span class="data-row-secondary">${winRate}%</span>
          <span class="data-row-value ${i === 0 ? 'text-gold' : ''}">${b.raw_score.toFixed(1)}</span>
        </div>
      `;
    }).join('');

    staggerFadeIn(container.children, { delay: 30 });
  }

  function renderTopCombos(combos: any[], sparklineData: Record<string, number[]>) {
    const container = document.getElementById('top-combos');
    if (!container) return;

    container.innerHTML = combos.map((c, i) => {
      const winRate = c.uses > 0 ? ((c.first / c.uses) * 100).toFixed(0) : '0';
      // Use real historical sparkline data
      const comboKey = `${c.blade} ${c.ratchet} ${c.bit}`;
      const data = sparklineData[comboKey] || [0, 0, 0, 0, 0, 0, 0];
      const sparkline = generateTrendSparkline(data, { width: 50, height: 16 });

      return `
        <div class="data-row py-2 px-3 ${i === 0 ? 'bg-series-ux/5 border-l-2 border-series-ux' : ''}">
          <span class="data-row-rank ${i === 0 ? 'text-series-ux' : ''}">${i + 1}</span>
          <span class="data-row-name text-xs">
            <span class="${i === 0 ? 'text-series-ux font-bold' : 'text-fg'}">${c.blade}</span>
            <span class="text-fg-muted">${c.ratchet}</span>
            <span class="text-fg-muted">${c.bit}</span>
          </span>
          <span class="sparkline ml-2">${sparkline}</span>
          <span class="data-row-secondary">${winRate}%</span>
          <span class="data-row-value ${i === 0 ? 'text-series-ux' : ''}">${c.raw_score.toFixed(1)}</span>
        </div>
      `;
    }).join('');

    staggerFadeIn(container.children, { delay: 30 });
  }

  function renderPartBars(ratchets: any[], bits: any[]) {
    const ratchetContainer = document.getElementById('ratchet-bars');
    const bitContainer = document.getElementById('bit-bars');

    const maxRatchetUses = ratchets[0]?.uses || 1;
    const maxBitUses = bits[0]?.uses || 1;

    if (ratchetContainer) {
      ratchetContainer.innerHTML = ratchets.slice(0, 5).map((r, i) => {
        const percentage = Math.round((r.uses / maxRatchetUses) * 100);
        return `
          <div class="group">
            <div class="flex items-center justify-between text-xs mb-1">
              <span class="font-mono text-fg">${r.name}</span>
              <span class="text-fg-muted tabular-nums">${r.uses}</span>
            </div>
            <div class="micro-bar">
              <div class="micro-bar-fill bg-series-ux" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    if (bitContainer) {
      bitContainer.innerHTML = bits.slice(0, 5).map((b, i) => {
        const percentage = Math.round((b.uses / maxBitUses) * 100);
        return `
          <div class="group">
            <div class="flex items-center justify-between text-xs mb-1">
              <span class="font-mono text-fg">${b.name}</span>
              <span class="text-fg-muted tabular-nums">${b.uses}</span>
            </div>
            <div class="micro-bar">
              <div class="micro-bar-fill bg-series-bx" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }
  }

  function renderSeriesBlades(containerId: string, blades: any[], colorClass: string) {
    const container = document.getElementById(containerId);
    if (!container) return;

    if (!blades || blades.length === 0) {
      container.innerHTML = '<div class="text-fg-muted text-xs text-center py-2">No data</div>';
      return;
    }

    container.innerHTML = blades.map((b, i) => `
      <div class="data-row">
        <span class="data-row-rank text-${colorClass}">${i + 1}</span>
        <span class="data-row-name">${b.blade}</span>
        <span class="data-row-secondary">${b.uses}</span>
        <span class="data-row-value text-${colorClass}">${b.raw_score.toFixed(1)}</span>
      </div>
    `).join('');

    staggerFadeIn(container.children, { delay: 30 });
  }

  function renderMetaLandscape(blades: any[]) {
    const canvas = document.getElementById('meta-landscape-chart') as HTMLCanvasElement;
    if (!canvas) return;

    if (metaLandscapeChart) {
      metaLandscapeChart.destroy();
      metaLandscapeChart = null;
    }

    const topBlades = blades.slice(0, 20);
    const maxScore = Math.max(...topBlades.map(b => b.raw_score));

    // Official packaging colors
    const seriesColors: Record<string, string> = {
      BX: 'rgba(0, 104, 183, 0.7)',    // #0068B7 - Blue
      UX: 'rgba(242, 101, 34, 0.7)',   // #F26522 - Orange
      CX: 'rgba(228, 0, 127, 0.7)',    // #E4007F - Pink
    };

    const bubbleData = topBlades
      .filter(b => BLADE_SERIES[b.blade])
      .map(b => {
        const series = BLADE_SERIES[b.blade];
        const winRate = b.uses > 0 ? (b.first / b.uses) * 100 : 0;
        const normalizedScore = (b.raw_score / maxScore) * 20 + 4;

        return {
          x: b.uses,
          y: winRate,
          r: normalizedScore,
          blade: b.blade,
          series,
          score: b.raw_score,
        };
      });

    const datasets = ['BX', 'UX', 'CX'].map(series => ({
      label: series,
      data: bubbleData.filter(d => d.series === series),
      backgroundColor: seriesColors[series],
      borderColor: seriesColors[series].replace('0.7', '1'),
      borderWidth: 1,
    })).filter(ds => ds.data.length > 0);

    metaLandscapeChart = new Chart(canvas, {
      type: 'bubble',
      data: { datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(22, 27, 34, 0.95)',
            titleColor: '#fbbf24',
            bodyColor: '#f5f5f5',
            borderColor: '#30363d',
            borderWidth: 1,
            padding: 8,
            titleFont: { family: 'monospace', size: 11, weight: 'bold' },
            bodyFont: { family: 'monospace', size: 10 },
            callbacks: {
              title: (items: any) => items[0]?.raw?.blade || '',
              label: (context: any) => {
                const d = context.raw;
                return [`Uses: ${d.x}`, `1st%: ${d.y.toFixed(0)}%`, `Score: ${d.score.toFixed(1)}`];
              },
            },
          },
        },
        scales: {
          x: {
            title: { display: false },
            grid: { color: 'rgba(48, 54, 61, 0.5)' },
            ticks: { color: '#666666', font: { family: 'monospace', size: 9 } },
          },
          y: {
            min: 0,
            max: 100,
            title: { display: false },
            grid: { color: 'rgba(48, 54, 61, 0.5)' },
            ticks: { color: '#666666', font: { family: 'monospace', size: 9 }, callback: (v: any) => `${v}%` },
          },
        },
      },
    });
  }

  async function loadMetaEvolution(region: Region) {
    try {
      const evolution = await getMetaEvolution(region);
      renderMetaEvolution(evolution);
    } catch (error) {
      console.error('Failed to load meta evolution:', error);
      const loadingEl = document.getElementById('meta-evolution-loading');
      if (loadingEl) {
        loadingEl.innerHTML = '<div class="text-fg-muted text-sm text-center py-4">Unable to load meta history</div>';
      }
    }
  }

  function renderMetaEvolution(data: MetaEvolutionData) {
    const loadingEl = document.getElementById('meta-evolution-loading');
    const contentEl = document.getElementById('meta-evolution-content');
    const eraCardsEl = document.getElementById('era-cards');
    const journeyChartEl = document.getElementById('blade-journey-chart');
    const journeyLegendEl = document.getElementById('blade-journey-legend');

    if (!data.eras.length) {
      if (loadingEl) loadingEl.innerHTML = '<div class="text-fg-muted text-sm text-center py-4">Not enough data for meta evolution</div>';
      return;
    }

    // Colors for eras and blades - use static classes for Tailwind to detect
    const eraStyles = [
      { border: 'border-series-bx/30', bg: 'bg-series-bx', text: 'text-series-bx' },
      { border: 'border-series-ux/30', bg: 'bg-series-ux', text: 'text-series-ux' },
      { border: 'border-series-cx/30', bg: 'bg-series-cx', text: 'text-series-cx' },
      { border: 'border-tier-ss/30', bg: 'bg-tier-ss', text: 'text-tier-ss' },
    ];
    const bladeColors = ['#22d3ee', '#4ade80', '#fbbf24', '#f472b6', '#a78bfa', '#fb923c', '#38bdf8', '#34d399', '#facc15', '#f87171'];

    // Render era cards
    if (eraCardsEl) {
      eraCardsEl.innerHTML = data.eras.map((era, i) => {
        const style = eraStyles[i % eraStyles.length];
        return `
        <div class="terminal-panel p-3 ${style.border}">
          <div class="flex items-center gap-2 mb-2">
            <div class="w-2 h-2 rounded-full ${style.bg}"></div>
            <span class="font-mono text-xs ${style.text} uppercase tracking-wider">${era.name}</span>
          </div>
          <div class="text-[10px] text-fg-muted mb-2">${era.startDate} → ${era.endDate}</div>
          <div class="space-y-1">
            ${era.topBlades.slice(0, 3).map((b, j) => `
              <div class="flex items-center justify-between text-xs">
                <span class="font-mono text-fg truncate">${j + 1}. ${b.blade}</span>
                <span class="text-fg-muted">${b.wins}W</span>
              </div>
            `).join('')}
          </div>
        </div>
      `}).join('');
    }

    // Render blade journey visualization (SVG bump chart)
    if (journeyChartEl && data.bladeJourneys.length > 0) {
      const months = data.timeline.map(t => t.month);
      const width = journeyChartEl.clientWidth || 600;
      const height = 160;
      const padding = { top: 10, right: 20, bottom: 20, left: 30 };
      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;

      // Only show top 6 blades for clarity
      const topJourneys = data.bladeJourneys.slice(0, 6);
      const maxRank = 8; // Only show ranks 1-8

      // Create SVG
      let svg = `<svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">`;
      
      // Grid lines for ranks
      for (let rank = 1; rank <= maxRank; rank++) {
        const y = padding.top + ((rank - 1) / (maxRank - 1)) * chartHeight;
        svg += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>`;
        svg += `<text x="${padding.left - 5}" y="${y + 3}" fill="#6b7280" font-size="9" text-anchor="end" font-family="monospace">${rank}</text>`;
      }

      // Month labels (show every other month if many)
      const step = months.length > 8 ? 2 : 1;
      months.forEach((month, i) => {
        if (i % step !== 0 && i !== months.length - 1) return;
        const x = padding.left + (i / (months.length - 1)) * chartWidth;
        const label = month.slice(2); // Just "24-01" format
        svg += `<text x="${x}" y="${height - 5}" fill="#6b7280" font-size="8" text-anchor="middle" font-family="monospace">${label}</text>`;
      });

      // Draw journey lines
      topJourneys.forEach((journey, idx) => {
        const color = bladeColors[idx % bladeColors.length];
        const points: string[] = [];
        
        journey.monthlyRanks.forEach((mr, i) => {
          if (mr.rank !== null && mr.rank <= maxRank) {
            const x = padding.left + (i / (months.length - 1)) * chartWidth;
            const y = padding.top + ((mr.rank - 1) / (maxRank - 1)) * chartHeight;
            points.push(`${x},${y}`);
          }
        });

        if (points.length > 1) {
          // Draw line
          svg += `<polyline points="${points.join(' ')}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity="0.8"/>`;
          
          // Draw dots at each point
          journey.monthlyRanks.forEach((mr, i) => {
            if (mr.rank !== null && mr.rank <= maxRank) {
              const x = padding.left + (i / (months.length - 1)) * chartWidth;
              const y = padding.top + ((mr.rank - 1) / (maxRank - 1)) * chartHeight;
              svg += `<circle cx="${x}" cy="${y}" r="3" fill="${color}" stroke="#1a1a2e" stroke-width="1"/>`;
            }
          });
        }
      });

      svg += '</svg>';
      journeyChartEl.innerHTML = svg;
    }

    // Render legend
    if (journeyLegendEl && data.bladeJourneys.length > 0) {
      const topJourneys = data.bladeJourneys.slice(0, 6);
      journeyLegendEl.innerHTML = topJourneys.map((journey, idx) => {
        const color = bladeColors[idx % bladeColors.length];
        const trendIcon = journey.trend === 'rising' ? '↑' : journey.trend === 'falling' ? '↓' : journey.trend === 'new' ? '★' : journey.trend === 'gone' ? '○' : '→';
        const trendClass = journey.trend === 'rising' ? 'text-positive' : journey.trend === 'falling' ? 'text-negative' : journey.trend === 'new' ? 'text-tier-ss' : 'text-fg-muted';
        return `
          <div class="flex items-center gap-1.5">
            <div class="w-3 h-0.5 rounded" style="background-color: ${color}"></div>
            <span class="font-mono text-fg">${journey.blade}</span>
            <span class="${trendClass}">${trendIcon}</span>
          </div>
        `;
      }).join('');
    }

    // Show content
    loadingEl?.classList.add('hidden');
    contentEl?.classList.remove('hidden');
  }

  document.addEventListener('DOMContentLoaded', loadDashboard);
  window.addEventListener('regionchange', loadDashboard);
</script>
