---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Meta Dashboard">
  <div class="max-w-9xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

    {/* ============================================
        META CHAMPION SPOTLIGHT (Full-width Hero)
        ============================================ */}
    <section class="mb-6">
      <div id="meta-spotlight">
        <!-- Loading State -->
        <div id="spotlight-loading" class="champion-spotlight p-8 h-48 flex items-center justify-center">
          <div class="flex items-center gap-3">
            <div class="w-6 h-6 border-2 border-terminal-border border-t-gold rounded-full animate-spin"></div>
            <span class="text-fg-muted font-mono text-sm">LOADING META DATA...</span>
          </div>
        </div>
      </div>
    </section>

    {/* ============================================
        MARKET OVERVIEW + MOVERS ROW
        ============================================ */}
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      {/* Market Overview (Dense stat widgets) */}
      <div class="terminal-panel">
        <div class="terminal-panel-header">
          <span class="flex items-center gap-2">
            <span class="status-dot status-dot-live"></span>
            Market Overview
          </span>
          <span id="last-updated" class="text-fg-disabled">--:--:--</span>
        </div>
        <div class="terminal-panel-body">
          <div class="grid grid-cols-4 gap-3">
            <div class="stat-widget">
              <div class="stat-widget-label">Tournaments</div>
              <div id="stat-tournaments" class="stat-widget-value text-accent">--</div>
            </div>
            <div class="stat-widget">
              <div class="stat-widget-label">Players</div>
              <div id="stat-players" class="stat-widget-value text-series-ux">--</div>
            </div>
            <div class="stat-widget">
              <div class="stat-widget-label">Blades</div>
              <div id="stat-blades" class="stat-widget-value text-series-bx">--</div>
            </div>
            <div class="stat-widget">
              <div class="stat-widget-label">Combos</div>
              <div id="stat-combos" class="stat-widget-value text-series-cx">--</div>
            </div>
          </div>
        </div>
      </div>

      {/* Movers Panel (Risers | Fallers) */}
      <div class="terminal-panel">
        <div class="terminal-panel-header">
          <span>Movers</span>
          <span class="text-fg-disabled">30d</span>
        </div>
        <div class="terminal-panel-body">
          <div class="grid grid-cols-2 gap-4">
            {/* Risers */}
            <div>
              <div class="text-[10px] font-mono uppercase tracking-widest text-positive mb-2 flex items-center gap-1">
                <span class="delta-up"></span> Risers
              </div>
              <div id="movers-risers" class="space-y-1">
                <div class="data-row skeleton h-6"></div>
                <div class="data-row skeleton h-6"></div>
                <div class="data-row skeleton h-6"></div>
              </div>
            </div>
            {/* Fallers */}
            <div>
              <div class="text-[10px] font-mono uppercase tracking-widest text-negative mb-2 flex items-center gap-1">
                <span class="delta-down"></span> Fallers
              </div>
              <div id="movers-fallers" class="space-y-1">
                <div class="data-row skeleton h-6"></div>
                <div class="data-row skeleton h-6"></div>
                <div class="data-row skeleton h-6"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    {/* ============================================
        TOP PERFORMERS (Blades + Combos)
        ============================================ */}
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      {/* Top Blades */}
      <div class="terminal-panel">
        <div class="terminal-panel-header">
          <span class="flex items-center gap-2">
            <span class="text-accent">#</span> Top Blades
          </span>
          <a href="/blades" class="text-accent hover:text-fg text-[10px] uppercase tracking-wider transition-colors">
            View All
          </a>
        </div>
        <div id="top-blades" class="terminal-panel-body p-0">
          {[1, 2, 3, 4, 5, 6, 7, 8].map(() => (
            <div class="data-row skeleton h-8"></div>
          ))}
        </div>
      </div>

      {/* Top Combos */}
      <div class="terminal-panel">
        <div class="terminal-panel-header">
          <span class="flex items-center gap-2">
            <span class="text-series-ux">#</span> Top Combos
          </span>
          <a href="/combos" class="text-series-ux hover:text-fg text-[10px] uppercase tracking-wider transition-colors">
            View All
          </a>
        </div>
        <div id="top-combos" class="terminal-panel-body p-0">
          {[1, 2, 3, 4, 5, 6, 7, 8].map(() => (
            <div class="data-row skeleton h-8"></div>
          ))}
        </div>
      </div>
    </section>

    {/* ============================================
        PARTS ANALYSIS (Ratchets + Bits)
        ============================================ */}
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      {/* Top Ratchets */}
      <div class="terminal-panel">
        <div class="terminal-panel-header">
          <span class="flex items-center gap-2">
            <span class="text-series-ux">#</span> Ratchets
          </span>
          <a href="/ratchets" class="text-series-ux hover:text-fg text-[10px] uppercase tracking-wider transition-colors">
            View All
          </a>
        </div>
        <div id="ratchet-bars" class="terminal-panel-body space-y-2">
          {[1, 2, 3, 4, 5].map(() => (
            <div class="skeleton h-6 rounded"></div>
          ))}
        </div>
      </div>

      {/* Top Bits */}
      <div class="terminal-panel">
        <div class="terminal-panel-header">
          <span class="flex items-center gap-2">
            <span class="text-series-bx">#</span> Bits
          </span>
          <a href="/bits" class="text-series-bx hover:text-fg text-[10px] uppercase tracking-wider transition-colors">
            View All
          </a>
        </div>
        <div id="bit-bars" class="terminal-panel-body space-y-2">
          {[1, 2, 3, 4, 5].map(() => (
            <div class="skeleton h-6 rounded"></div>
          ))}
        </div>
      </div>
    </section>

    {/* ============================================
        META LANDSCAPE (Full-width Chart)
        ============================================ */}
    <section class="mb-6">
      <div class="terminal-panel">
        <div class="terminal-panel-header">
          <span class="flex items-center gap-2">
            <span class="text-accent">#</span> Meta Landscape
          </span>
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-3 text-[10px]">
              <div class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-series-bx"></span>
                <span class="text-fg-muted">BX</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-series-ux"></span>
                <span class="text-fg-muted">UX</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-series-cx"></span>
                <span class="text-fg-muted">CX</span>
              </div>
            </div>
            <span class="text-fg-disabled text-[10px]">Uses vs Win% (bubble = score)</span>
          </div>
        </div>
        <div class="terminal-panel-body">
          <div class="relative h-64 md:h-80">
            <canvas id="meta-landscape-chart"></canvas>
          </div>
        </div>
      </div>
    </section>

    {/* ============================================
        SERIES BREAKDOWN (BX / UX / CX)
        ============================================ */}
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      {/* BX Series */}
      <div class="terminal-panel border-series-bx/30">
        <div class="terminal-panel-header bg-series-bx/10">
          <span class="flex items-center gap-2">
            <span class="badge-bx text-[10px] px-1.5 py-0.5">BX</span>
            Basic Series
          </span>
        </div>
        <div id="series-bx" class="terminal-panel-body p-0">
          {[1, 2, 3, 4, 5].map(() => (
            <div class="data-row skeleton h-6"></div>
          ))}
        </div>
      </div>

      {/* UX Series */}
      <div class="terminal-panel border-series-ux/30">
        <div class="terminal-panel-header bg-series-ux/10">
          <span class="flex items-center gap-2">
            <span class="badge-ux text-[10px] px-1.5 py-0.5">UX</span>
            Unique Series
          </span>
        </div>
        <div id="series-ux" class="terminal-panel-body p-0">
          {[1, 2, 3, 4, 5].map(() => (
            <div class="data-row skeleton h-6"></div>
          ))}
        </div>
      </div>

      {/* CX Series */}
      <div class="terminal-panel border-series-cx/30">
        <div class="terminal-panel-header bg-series-cx/10">
          <span class="flex items-center gap-2">
            <span class="badge-cx text-[10px] px-1.5 py-0.5">CX</span>
            Custom Line
          </span>
        </div>
        <div id="series-cx" class="terminal-panel-body p-0">
          {[1, 2, 3, 4, 5].map(() => (
            <div class="data-row skeleton h-6"></div>
          ))}
        </div>
      </div>
    </section>

  </div>
</Layout>

<script>
  import { initDB, getDatabaseSummary, getRankedBlades, getRankedCombos, getRankedRatchets, getRankedBits, getMetaSpotlight, getTopBladesBySeries, BLADE_SERIES, type Region } from '../lib/db';
  import { staggerFadeIn, animateNumber } from '../lib/animations';
  import { generateTrendSparkline } from '../lib/sparkline';
  import { Chart, BubbleController, LinearScale, PointElement, Tooltip, Legend } from 'chart.js';

  Chart.register(BubbleController, LinearScale, PointElement, Tooltip, Legend);

  let metaLandscapeChart: Chart | null = null;

  function getSelectedRegion(): Region {
    if (typeof localStorage !== 'undefined') {
      return (localStorage.getItem('beyblade-region') as Region) || 'ALL';
    }
    return 'ALL';
  }

  async function loadDashboard() {
    try {
      await initDB();
      const region = getSelectedRegion();

      // Update timestamp
      const lastUpdated = document.getElementById('last-updated');
      if (lastUpdated) {
        const now = new Date();
        lastUpdated.textContent = now.toLocaleTimeString('en-US', { hour12: false });
      }

      // Load all data in parallel
      const [summary, blades, combos, ratchets, bits, spotlight, seriesBlades, allBlades] = await Promise.all([
        getDatabaseSummary(region),
        getRankedBlades(8, 3, region),
        getRankedCombos(8, 2, region),
        getRankedRatchets(5, 3, region),
        getRankedBits(5, 3, region),
        getMetaSpotlight(region),
        getTopBladesBySeries(5, 2, region),
        getRankedBlades(50, 2, region),
      ]);

      // Render champion spotlight
      renderChampionSpotlight(spotlight);

      // Render movers
      renderMovers(spotlight);

      // Update stats
      const tournamentsEl = document.getElementById('stat-tournaments');
      const playersEl = document.getElementById('stat-players');
      const bladesEl = document.getElementById('stat-blades');
      const combosEl = document.getElementById('stat-combos');

      if (tournamentsEl) animateNumber(tournamentsEl, summary.tournaments);
      if (playersEl) animateNumber(playersEl, summary.unique_players);
      if (bladesEl) animateNumber(bladesEl, summary.unique_blades);
      if (combosEl) animateNumber(combosEl, combos.length > 0 ? summary.unique_blades * 2 : 0);

      // Render top blades with sparklines
      renderTopBlades(blades);

      // Render top combos
      renderTopCombos(combos);

      // Render part bars
      renderPartBars(ratchets, bits);

      // Render series rankings
      renderSeriesBlades('series-bx', seriesBlades.BX, 'series-bx');
      renderSeriesBlades('series-ux', seriesBlades.UX, 'series-ux');
      renderSeriesBlades('series-cx', seriesBlades.CX, 'series-cx');

      // Render meta landscape
      renderMetaLandscape(allBlades);

    } catch (error) {
      console.error('Failed to load dashboard:', error);
      document.querySelectorAll('.skeleton').forEach(el => {
        el.classList.remove('skeleton');
        el.innerHTML = '<div class="text-center text-negative py-2 text-xs">Error</div>';
      });
    }
  }

  function renderChampionSpotlight(spotlight: { champion: any; risers: any[]; fallers: any[]; lastTournamentDate: string | null; isStale: boolean; dataSource: 'recent' | 'alltime' }) {
    const container = document.getElementById('meta-spotlight');
    if (!container) return;

    if (!spotlight.champion) {
      container.innerHTML = `
        <div class="terminal-panel p-6 text-center">
          <div class="text-fg-muted font-mono">No tournament data available</div>
        </div>
      `;
      return;
    }

    const { champion, isStale } = spotlight;
    const metaShare = ((champion.uses / 100) * champion.winRate).toFixed(1);

    container.innerHTML = `
      <div class="champion-spotlight">
        <div class="relative p-6 md:p-8">
          <!-- Status Badge -->
          <div class="absolute top-4 right-4 flex items-center gap-2">
            <span class="status-dot ${isStale ? 'status-dot-stale' : 'status-dot-live'}"></span>
            <span class="text-[10px] font-mono uppercase tracking-widest ${isStale ? 'text-series-cx' : 'text-positive'}">
              ${isStale ? 'HISTORICAL' : 'LIVE'}
            </span>
          </div>

          <!-- Champion Label -->
          <div class="text-[10px] font-mono uppercase tracking-widest text-gold mb-2">
            Meta Champion
          </div>

          <!-- Champion Name (Hero Element) -->
          <h1 class="champion-name text-fg mb-4">
            ${champion.blade} ${champion.ratchet} ${champion.bit}
          </h1>

          <!-- Stats Grid -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
            <div class="text-center">
              <div class="text-3xl md:text-4xl font-mono font-bold text-gold tabular-nums">${champion.score.toFixed(1)}</div>
              <div class="text-[10px] font-mono uppercase tracking-widest text-fg-muted mt-1">Score</div>
            </div>
            <div class="text-center">
              <div class="text-3xl md:text-4xl font-mono font-bold text-positive tabular-nums">${champion.winRate}%</div>
              <div class="text-[10px] font-mono uppercase tracking-widest text-fg-muted mt-1">1st Rate</div>
            </div>
            <div class="text-center">
              <div class="text-3xl md:text-4xl font-mono font-bold text-series-ux tabular-nums">${champion.uses}</div>
              <div class="text-[10px] font-mono uppercase tracking-widest text-fg-muted mt-1">Uses</div>
            </div>
            <div class="text-center">
              <div class="text-3xl md:text-4xl font-mono font-bold text-accent tabular-nums">${metaShare}%</div>
              <div class="text-[10px] font-mono uppercase tracking-widest text-fg-muted mt-1">Meta Share</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderMovers(spotlight: { risers: any[]; fallers: any[] }) {
    const risersContainer = document.getElementById('movers-risers');
    const fallersContainer = document.getElementById('movers-fallers');

    if (risersContainer) {
      if (spotlight.risers.length === 0) {
        risersContainer.innerHTML = '<div class="text-fg-muted text-xs py-2">No risers</div>';
      } else {
        risersContainer.innerHTML = spotlight.risers.slice(0, 3).map(r => `
          <div class="data-row">
            <span class="data-row-name">${r.blade}</span>
            <span class="delta-up text-xs">+${r.change}</span>
          </div>
        `).join('');
      }
    }

    if (fallersContainer) {
      if (spotlight.fallers.length === 0) {
        fallersContainer.innerHTML = '<div class="text-fg-muted text-xs py-2">No fallers</div>';
      } else {
        fallersContainer.innerHTML = spotlight.fallers.slice(0, 3).map(f => `
          <div class="data-row">
            <span class="data-row-name">${f.blade}</span>
            <span class="delta-down text-xs">${f.change}</span>
          </div>
        `).join('');
      }
    }
  }

  function renderTopBlades(blades: any[]) {
    const container = document.getElementById('top-blades');
    if (!container) return;

    container.innerHTML = blades.map((b, i) => {
      const winRate = b.uses > 0 ? ((b.first / b.uses) * 100).toFixed(0) : '0';
      // Generate sample sparkline data based on trend
      const sparklineData = generateSparklineData(b.trend);
      const sparkline = generateTrendSparkline(sparklineData, { width: 50, height: 16 });

      return `
        <div class="data-row py-2 px-3 ${i === 0 ? 'bg-gold/5 border-l-2 border-gold' : ''}">
          <span class="data-row-rank ${i === 0 ? 'text-gold' : ''}">${i + 1}</span>
          <span class="data-row-name ${i === 0 ? 'text-gold font-bold' : ''}">${b.blade}</span>
          <span class="sparkline ml-2">${sparkline}</span>
          <span class="data-row-secondary">${b.uses}</span>
          <span class="data-row-secondary">${winRate}%</span>
          <span class="data-row-value ${i === 0 ? 'text-gold' : ''}">${b.raw_score.toFixed(1)}</span>
        </div>
      `;
    }).join('');

    staggerFadeIn(container.children, { delay: 30 });
  }

  function renderTopCombos(combos: any[]) {
    const container = document.getElementById('top-combos');
    if (!container) return;

    container.innerHTML = combos.map((c, i) => {
      const winRate = c.uses > 0 ? ((c.first / c.uses) * 100).toFixed(0) : '0';
      const sparklineData = generateSparklineData(c.trend);
      const sparkline = generateTrendSparkline(sparklineData, { width: 50, height: 16 });

      return `
        <div class="data-row py-2 px-3 ${i === 0 ? 'bg-series-ux/5 border-l-2 border-series-ux' : ''}">
          <span class="data-row-rank ${i === 0 ? 'text-series-ux' : ''}">${i + 1}</span>
          <span class="data-row-name text-xs">
            <span class="${i === 0 ? 'text-series-ux font-bold' : 'text-fg'}">${c.blade}</span>
            <span class="text-fg-muted">${c.ratchet}</span>
            <span class="text-fg-muted">${c.bit}</span>
          </span>
          <span class="sparkline ml-2">${sparkline}</span>
          <span class="data-row-secondary">${winRate}%</span>
          <span class="data-row-value ${i === 0 ? 'text-series-ux' : ''}">${c.raw_score.toFixed(1)}</span>
        </div>
      `;
    }).join('');

    staggerFadeIn(container.children, { delay: 30 });
  }

  function renderPartBars(ratchets: any[], bits: any[]) {
    const ratchetContainer = document.getElementById('ratchet-bars');
    const bitContainer = document.getElementById('bit-bars');

    const maxRatchetUses = ratchets[0]?.uses || 1;
    const maxBitUses = bits[0]?.uses || 1;

    if (ratchetContainer) {
      ratchetContainer.innerHTML = ratchets.slice(0, 5).map((r, i) => {
        const percentage = Math.round((r.uses / maxRatchetUses) * 100);
        return `
          <div class="group">
            <div class="flex items-center justify-between text-xs mb-1">
              <span class="font-mono text-fg">${r.name}</span>
              <span class="text-fg-muted tabular-nums">${r.uses}</span>
            </div>
            <div class="micro-bar">
              <div class="micro-bar-fill bg-series-ux" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    if (bitContainer) {
      bitContainer.innerHTML = bits.slice(0, 5).map((b, i) => {
        const percentage = Math.round((b.uses / maxBitUses) * 100);
        return `
          <div class="group">
            <div class="flex items-center justify-between text-xs mb-1">
              <span class="font-mono text-fg">${b.name}</span>
              <span class="text-fg-muted tabular-nums">${b.uses}</span>
            </div>
            <div class="micro-bar">
              <div class="micro-bar-fill bg-series-bx" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }
  }

  function renderSeriesBlades(containerId: string, blades: any[], colorClass: string) {
    const container = document.getElementById(containerId);
    if (!container) return;

    if (!blades || blades.length === 0) {
      container.innerHTML = '<div class="text-fg-muted text-xs text-center py-2">No data</div>';
      return;
    }

    container.innerHTML = blades.map((b, i) => `
      <div class="data-row">
        <span class="data-row-rank text-${colorClass}">${i + 1}</span>
        <span class="data-row-name">${b.blade}</span>
        <span class="data-row-secondary">${b.uses}</span>
        <span class="data-row-value text-${colorClass}">${b.raw_score.toFixed(1)}</span>
      </div>
    `).join('');

    staggerFadeIn(container.children, { delay: 30 });
  }

  function renderMetaLandscape(blades: any[]) {
    const canvas = document.getElementById('meta-landscape-chart') as HTMLCanvasElement;
    if (!canvas) return;

    if (metaLandscapeChart) {
      metaLandscapeChart.destroy();
      metaLandscapeChart = null;
    }

    const topBlades = blades.slice(0, 20);
    const maxScore = Math.max(...topBlades.map(b => b.raw_score));

    // Official packaging colors
    const seriesColors: Record<string, string> = {
      BX: 'rgba(0, 104, 183, 0.7)',    // #0068B7 - Blue
      UX: 'rgba(242, 101, 34, 0.7)',   // #F26522 - Orange
      CX: 'rgba(228, 0, 127, 0.7)',    // #E4007F - Pink
    };

    const bubbleData = topBlades
      .filter(b => BLADE_SERIES[b.blade])
      .map(b => {
        const series = BLADE_SERIES[b.blade];
        const winRate = b.uses > 0 ? (b.first / b.uses) * 100 : 0;
        const normalizedScore = (b.raw_score / maxScore) * 20 + 4;

        return {
          x: b.uses,
          y: winRate,
          r: normalizedScore,
          blade: b.blade,
          series,
          score: b.raw_score,
        };
      });

    const datasets = ['BX', 'UX', 'CX'].map(series => ({
      label: series,
      data: bubbleData.filter(d => d.series === series),
      backgroundColor: seriesColors[series],
      borderColor: seriesColors[series].replace('0.7', '1'),
      borderWidth: 1,
    })).filter(ds => ds.data.length > 0);

    metaLandscapeChart = new Chart(canvas, {
      type: 'bubble',
      data: { datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(22, 27, 34, 0.95)',
            titleColor: '#fbbf24',
            bodyColor: '#f5f5f5',
            borderColor: '#30363d',
            borderWidth: 1,
            padding: 8,
            titleFont: { family: 'monospace', size: 11, weight: 'bold' },
            bodyFont: { family: 'monospace', size: 10 },
            callbacks: {
              title: (items: any) => items[0]?.raw?.blade || '',
              label: (context: any) => {
                const d = context.raw;
                return [`Uses: ${d.x}`, `1st%: ${d.y.toFixed(0)}%`, `Score: ${d.score.toFixed(1)}`];
              },
            },
          },
        },
        scales: {
          x: {
            title: { display: false },
            grid: { color: 'rgba(48, 54, 61, 0.5)' },
            ticks: { color: '#666666', font: { family: 'monospace', size: 9 } },
          },
          y: {
            min: 0,
            max: 100,
            title: { display: false },
            grid: { color: 'rgba(48, 54, 61, 0.5)' },
            ticks: { color: '#666666', font: { family: 'monospace', size: 9 }, callback: (v: any) => `${v}%` },
          },
        },
      },
    });
  }

  function generateSparklineData(trend: number): number[] {
    const points = 7;
    const data: number[] = [];
    let value = 50;

    for (let i = 0; i < points; i++) {
      const noise = (Math.random() - 0.5) * 15;
      const trendForce = (trend || 0) * 5 * (i / points);
      value += noise + trendForce;
      value = Math.max(20, Math.min(80, value));
      data.push(value);
    }

    return data;
  }

  document.addEventListener('DOMContentLoaded', loadDashboard);
  window.addEventListener('regionchange', loadDashboard);
</script>
